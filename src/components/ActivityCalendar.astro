---
import { getGithubActivityData } from "./data/github-activity-data"
import { tf } from "../lib/format-text"
import type { Theme, ThemeProps } from "../types/theme"
import { themes } from "../constants/themes"
import { LAYOUT } from "../constants/layout"
import { buildCells, buildMonthLabels } from "../lib/builders"

interface Props {
  user: string
  locale?: string
  hoverMessage?: string
  totalMessage?: string
  theme?: Theme
  cache?: boolean
  themeProps?: ThemeProps
}

const {
  locale = "en",
  user,
  hoverMessage = "{{count}} contributions on {{date}}",
  totalMessage = "{{total}} total contributions",
  theme = "indigo",
  cache,
} = Astro.props

// Fetch GitHub activity data (server-side)
const { total, contributions } = await getGithubActivityData(user, cache)

// Current theme data
const { colors, meta } = themes[theme]

const cells = buildCells(contributions)
const monthLabels = buildMonthLabels(contributions, locale)
---

<div class="relative pb-8 lg:pt-4 lg:pb-4">
  <div
    id="activity-wrapper"
    class="relative"
    style={`width:${LAYOUT.SVG_W}px; height:${LAYOUT.SVG_H}px;`}
  >
    <svg
      id="activity-svg"
      width={LAYOUT.SVG_W}
      height={LAYOUT.SVG_H}
      viewBox={`0 0 ${LAYOUT.SVG_W} ${LAYOUT.SVG_H}`}
      style="display:block; overflow:visible;"
    >
      <g>
        {
          monthLabels.map((m) => (
            <text x={m.x} y={0} fill="currentColor" class={meta.text}>
              {m.label}
            </text>
          ))
        }
      </g>

      {
        cells.map((cell, i) => (
          <rect
            data-cell-index={i}
            x={cell.x}
            y={cell.y}
            width={LAYOUT.CELL}
            height={LAYOUT.CELL}
            rx="2"
            ry="2"
            fill={colors[cell.level]}
            style="stroke: rgba(255, 255, 255, 0.04); cursor:pointer;"
          />
        ))
      }
    </svg>

    <div
      id="activity-overlays"
      class="absolute top-0 left-0"
      style={`width:${LAYOUT.SVG_W}px; height:${LAYOUT.SVG_H}px;`}
    >
      {
        cells.map((cell, i) => {
          const tooltipText = tf(hoverMessage, {
            count: cell.count,
            date: new Date(cell.date).toLocaleString(locale, {
              month: "short",
              day: "numeric",
            }),
          })

          return (
            <div
              class="activity-overlay group pointer-events-auto absolute"
              data-cell-index={i}
              style={`left:0px; top:0px; width:${LAYOUT.CELL}px; height:${LAYOUT.CELL}px;`}
            >
              <span
                class={`pointer-events-none absolute bottom-full left-1/2 w-max -translate-x-1/2 -translate-y-0.5 rounded-md bg-neutral-800 px-2 py-1 text-xs opacity-0 transition-all group-hover:-translate-y-1 group-hover:opacity-100 ${meta.tooltipBg} ${meta.tooltipText}`}
              >
                {tooltipText}
              </span>
            </div>
          )
        })
      }
    </div>
  </div>

  <span
    class={`mt-2 block w-full text-left text-sm ${meta.text}`}
    set:html={tf(totalMessage, { total: total.lastYear })}
  />
</div>

<script type="module">
  function syncOverlays() {
    const svg = document.getElementById("activity-svg")
    const wrapper = document.getElementById("activity-wrapper")
    const overlays = document.querySelectorAll(
      "#activity-overlays .activity-overlay"
    )
    if (!svg || !wrapper || overlays.length === 0) return

    const wrapperRect = wrapper.getBoundingClientRect()
    const rects = svg.querySelectorAll("rect[data-cell-index]")

    rects.forEach((r) => {
      const idx = Number(r.getAttribute("data-cell-index"))
      const overlay = document.querySelector(
        `#activity-overlays .activity-overlay[data-cell-index="${idx}"]`
      )
      if (!overlay) return
      const rRect = r.getBoundingClientRect()

      overlay.style.left = `${Math.round(rRect.left - wrapperRect.left)}px`
      overlay.style.top = `${Math.round(rRect.top - wrapperRect.top)}px`
      overlay.style.width = `${Math.round(rRect.width)}px`
      overlay.style.height = `${Math.round(rRect.height)}px`
    })
  }

  function setupOverlaySync() {
    requestAnimationFrame(syncOverlays)
    window.addEventListener("resize", () => requestAnimationFrame(syncOverlays))

    const wrapper = document.getElementById("activity-wrapper")
    if (window.ResizeObserver && wrapper) {
      const ro = new ResizeObserver(() => requestAnimationFrame(syncOverlays))
      ro.observe(wrapper)
    }
  }

  document.addEventListener("DOMContentLoaded", setupOverlaySync)
  document.addEventListener("astro:after-swap", setupOverlaySync)
</script>
